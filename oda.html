<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Oda - Modern Chat & Oyun</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
  
  <style>
    :root {
      --bg-color: #0f172a;
      --sidebar-bg: rgba(30, 41, 59, 0.7);
      --card-bg: rgba(51, 65, 85, 0.4);
      --primary: #6366f1;
      --primary-hover: #4f46e5;
      --accent: #06b6d4;
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --border: rgba(255, 255, 255, 0.08);
      --glass: blur(12px) saturate(180%);
      --radius: 16px;
      --msg-me: #6366f1;
      --msg-other: rgba(255, 255, 255, 0.05);
    }

    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0;
      font-family: 'Plus Jakarta Sans', sans-serif;
      background: radial-gradient(circle at top left, #1e1b4b, #0f172a);
      color: var(--text-main);
      height: 100vh;
      overflow: hidden;
      display: flex;
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

    /* Layout */
    .app-container { display: flex; width: 100%; height: 100%; }
    
    /* Sidebar */
    .sidebar {
      width: 320px;
      background: var(--sidebar-bg);
      backdrop-filter: var(--glass);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      padding: 20px;
      transition: transform 0.3s ease;
      z-index: 10;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.2rem;
      font-weight: 700;
      color: #fff;
      margin-bottom: 24px;
    }
    .brand span { background: linear-gradient(135deg, var(--primary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

    .sidebar-section { margin-bottom: 20px; flex: 1; overflow-y: auto; }
    .sidebar-title { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 12px; font-weight: 600; }

    /* Inputs & Buttons */
    .input-group { position: relative; width: 100%; margin-bottom: 10px; }
    .input {
      width: 100%;
      background: rgba(0,0,0,0.2);
      border: 1px solid var(--border);
      color: #fff;
      padding: 12px 14px;
      border-radius: 10px;
      font-family: inherit;
      transition: all 0.2s;
    }
    .input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }
    
    .btn {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 10px;
      background: var(--primary);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
    }
    .btn:hover { background: var(--primary-hover); transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }
    .btn.ghost { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
    .btn.ghost:hover { background: rgba(255,255,255,0.05); color: #fff; }
    .btn-icon { width: 36px; padding: 0; }

    /* Room List */
    .room-item {
      padding: 12px;
      border-radius: 10px;
      background: rgba(255,255,255,0.03);
      margin-bottom: 8px;
      cursor: pointer;
      border: 1px solid transparent;
      transition: all 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .room-item:hover { background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.1); }
    .room-info h4 { margin: 0; font-size: 0.95rem; }
    .room-info p { margin: 2px 0 0; font-size: 0.8rem; color: var(--text-muted); }

    /* Main Content */
    .main { flex: 1; display: flex; flex-direction: column; position: relative; background: rgba(0,0,0,0.2); }
    
    .header {
      height: 70px;
      padding: 0 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(10px);
      background: rgba(15, 23, 42, 0.8);
    }
    .room-header-info h2 { margin: 0; font-size: 1.1rem; }
    .room-header-info span { font-size: 0.85rem; color: var(--text-muted); }

    .chat-area {
      flex: 1;
      padding: 20px 24px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .msg {
      max-width: 75%;
      padding: 10px 16px;
      border-radius: 14px;
      font-size: 0.95rem;
      line-height: 1.5;
      position: relative;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

    .msg.me {
      align-self: flex-end;
      background: var(--msg-me);
      color: #fff;
      border-bottom-right-radius: 2px;
    }
    .msg:not(.me) {
      align-self: flex-start;
      background: var(--msg-other);
      border: 1px solid var(--border);
      border-bottom-left-radius: 2px;
    }
    .msg .meta {
      font-size: 0.7rem;
      margin-bottom: 4px;
      opacity: 0.7;
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }
    .ban-badge { background: #ef4444; color: #fff; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; }

    /* Input Area */
    .chat-footer {
      padding: 20px 24px;
      border-top: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.9);
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }
    #chatInput {
      resize: none;
      min-height: 44px;
      max-height: 120px;
    }

    /* Right Sidebar (Members) */
    .members-sidebar {
      width: 260px;
      border-left: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.6);
      padding: 20px;
      display: flex;
      flex-direction: column;
    }
    .member-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px;
      margin-bottom: 4px;
      border-radius: 8px;
      font-size: 0.9rem;
    }
    .member-item:hover { background: rgba(255,255,255,0.03); }
    .badge-role { font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; background: var(--border); color: var(--text-muted); }
    .badge-role.owner { background: rgba(234, 179, 8, 0.2); color: #facc15; }
    .badge-role.mod { background: rgba(99, 102, 241, 0.2); color: #818cf8; }

    /* Game Area */
    .game-card {
      background: linear-gradient(135deg, rgba(6, 182, 212, 0.1), rgba(99, 102, 241, 0.1));
      border: 1px solid rgba(99, 102, 241, 0.2);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 10px;
    }
    .game-status { text-align: center; font-weight: 600; margin-bottom: 12px; color: var(--accent); }
    .game-choices { display: flex; justify-content: center; gap: 16px; }
    .game-btn {
      font-size: 1.5rem;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.05);
      cursor: pointer;
      transition: transform 0.2s;
    }
    .game-btn:hover { transform: scale(1.1); background: rgba(255,255,255,0.1); }
    .game-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Modal */
    .modal-overlay {
      position: fixed; inset: 0; z-index: 1000;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(8px);
      display: flex; align-items: center; justify-content: center;
      opacity: 0; pointer-events: none; transition: opacity 0.3s;
    }
    .modal-overlay.active { opacity: 1; pointer-events: all; }
    .modal-box {
      background: #1e293b;
      width: 100%; max-width: 400px;
      padding: 32px;
      border-radius: 20px;
      border: 1px solid var(--border);
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
      transform: scale(0.95); transition: transform 0.3s;
    }
    .modal-overlay.active .modal-box { transform: scale(1); }
    .modal-title { margin: 0 0 20px 0; font-size: 1.5rem; text-align: center; }

    /* Mobile */
    .mobile-menu-btn { display: none; background: transparent; border: none; color: #fff; font-size: 24px; cursor: pointer; }
    
    @media (max-width: 900px) {
      .members-sidebar { display: none; } /* Basitle≈ütirmek i√ßin mobilde √ºyeleri gizle */
    }
    @media (max-width: 768px) {
      .sidebar { position: fixed; height: 100%; transform: translateX(-100%); width: 280px; }
      .sidebar.open { transform: translateX(0); }
      .mobile-menu-btn { display: block; }
      .header h1 { font-size: 1rem; }
    }

    /* Toast */
    .toast {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(20px);
      background: #334155; color: #fff;
      padding: 12px 24px; border-radius: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
      opacity: 0; transition: all 0.3s; pointer-events: none; z-index: 2000;
      border: 1px solid var(--border);
      display: flex; align-items: center; gap: 8px;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    .toast.success { border-left: 4px solid #10b981; }
    .toast.error { border-left: 4px solid #ef4444; }

  </style>
</head>
<body>

  <div id="authModal" class="modal-overlay active">
    <div class="modal-box">
      <h2 class="modal-title">Giri≈ü Yap</h2>
      <p style="text-align:center; color:var(--text-muted); font-size:0.9rem; margin-bottom:20px;">
        Kullanƒ±cƒ± adƒ± yoksa otomatik hesap olu≈üturulur.
      </p>
      <div class="input-group">
        <input class="input" id="loginUsername" placeholder="Kullanƒ±cƒ± Adƒ±" autocomplete="off" />
      </div>
      <div class="input-group">
        <input class="input" id="loginPassword" type="password" placeholder="≈ûifre" />
      </div>
      <button class="btn" id="loginBtn">
        <span>Devam Et</span>
        <span class="material-icons-round">arrow_forward</span>
      </button>
      <div id="authError" style="color:#ef4444; margin-top:12px; text-align:center; font-size:0.9rem; min-height:20px;"></div>
      
      <div style="margin-top:20px; border-top:1px solid var(--border); padding-top:20px;">
        <button class="btn ghost" id="toggleAdminAuth" style="font-size:0.8rem;">Admin Giri≈üi (E-posta)</button>
      </div>
    </div>
  </div>

  <div id="adminModal" class="modal-overlay">
    <div class="modal-box">
      <h2 class="modal-title">Admin Paneli</h2>
      <div class="input-group">
        <input class="input" id="adminEmail" type="email" placeholder="admin@domain.com" />
      </div>
      <div class="input-group">
        <input class="input" id="adminPassword" type="password" placeholder="≈ûifre" />
      </div>
      <button class="btn" id="adminLoginBtn">Giri≈ü</button>
      <button class="btn ghost" id="toggleUserAuth" style="margin-top:10px;">Kullanƒ±cƒ± Giri≈üine D√∂n</button>
      <div id="adminError" style="color:#ef4444; margin-top:12px; text-align:center;"></div>
    </div>
  </div>

  <div class="app-container">
    <div class="sidebar" id="sidebar">
      <div class="brand">
        <span class="material-icons-round" style="color:var(--primary)">chat_bubble</span>
        <span>OdaChat</span>
      </div>
      
      <div class="sidebar-section">
        <div class="sidebar-title">Odalar</div>
        <div id="roomsList">
          <div style="padding:10px; color:var(--text-muted); text-align:center;">Y√ºkleniyor...</div>
        </div>
      </div>

      <div style="margin-top: auto;">
        <div class="sidebar-title">Yeni Oda</div>
        <div style="background:rgba(0,0,0,0.2); padding:12px; border-radius:12px; border:1px solid var(--border);">
          <input id="newRoomName" class="input" placeholder="Oda Adƒ±" style="margin-bottom:8px; font-size:0.9rem; padding:8px;" />
          <select id="newRoomType" class="input" style="margin-bottom:8px; font-size:0.9rem; padding:8px;">
            <option value="Genel">Genel Sohbet</option>
            <option value="Oyun">Oyun</option>
            <option value="M√ºzik">M√ºzik</option>
          </select>
          <button id="createRoomBtn" class="btn" style="padding:8px; font-size:0.9rem;">Olu≈ütur</button>
        </div>
        
        <div style="display:flex; align-items:center; gap:10px; margin-top:20px; padding-top:15px; border-top:1px solid var(--border);">
          <div style="flex:1;">
            <div id="meName" style="font-weight:600; font-size:0.9rem;">Misafir</div>
            <div id="userBadge" style="font-size:0.75rem; color:var(--accent);"></div>
          </div>
          <button id="logoutBtn" class="btn ghost btn-icon"><span class="material-icons-round">logout</span></button>
        </div>
      </div>
    </div>

    <div class="main">
      <div class="header">
        <button class="mobile-menu-btn" id="mobileMenuBtn">
          <span class="material-icons-round">menu</span>
        </button>
        <div class="room-header-info" style="margin-left:12px;">
          <h2 id="roomTitle">Oda Se√ßimi</h2>
          <span id="roomMeta">Sohbete ba≈ülamak i√ßin bir odaya katƒ±lƒ±n</span>
        </div>
        <div style="display:flex; gap:10px;">
           <button id="leaveRoomBtn" class="btn ghost" style="padding:8px 16px; display:none;">Ayrƒ±l</button>
        </div>
      </div>

      <div class="chat-area" id="chatMessages">
        <div style="text-align:center; margin-top:50px; color:var(--text-muted);">
          <span class="material-icons-round" style="font-size:48px; opacity:0.5;">forum</span>
          <p>Sol men√ºden bir oda se√ßin veya olu≈üturun.</p>
        </div>
      </div>

      <div id="gameContainer" style="padding:0 24px; display:none;">
        <div class="game-card">
           <div class="game-status" id="tkgmStatus">Ta≈ü-Kaƒüƒ±t-Makas: Ba≈ülamak i√ßin hamle yap</div>
           <div class="game-choices" id="tkgmChoices">
             <button class="game-btn" data-choice="rock">ü™®</button>
             <button class="game-btn" data-choice="paper">üìÑ</button>
             <button class="game-btn" data-choice="scissors">‚úÇÔ∏è</button>
           </div>
        </div>
      </div>

      <div class="chat-footer">
        <textarea id="chatInput" class="input" placeholder="Bir mesaj yaz..." disabled></textarea>
        <button id="sendBtn" class="btn btn-icon" disabled>
          <span class="material-icons-round">send</span>
        </button>
      </div>
    </div>

    <div class="members-sidebar">
      <div class="sidebar-title" style="display:flex; justify-content:space-between;">
        <span>√úyeler</span>
        <span id="membersCount">0</span>
      </div>
      <div id="membersList" style="overflow-y:auto; flex:1;">
        </div>
    </div>
  </div>

  <div id="toastWrapper"></div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // --- YAPILANDIRMA ---
    const firebaseConfig = {
      apiKey: "AIzaSyBlirRiiNPpdqmTAmq6DsSq8mCUlgBHgVc",
      authDomain: "lilemir-new.firebaseapp.com",
      projectId: "lilemir-new",
      storageBucket: "lilemir-new.firebasestorage.app",
      messagingSenderId: "339863121380",
      appId: "1:339863121380:web:123195552e821b085e6bf1"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- DOM ELEMENTLERƒ∞ ---
    const el = id => document.getElementById(id);
    const authModal = el('authModal');
    const adminModal = el('adminModal');
    const loginBtn = el('loginBtn');
    const authError = el('authError');
    const adminError = el('adminError');
    const chatInput = el('chatInput');
    const sendBtn = el('sendBtn');
    const chatMessages = el('chatMessages');
    const roomTitle = el('roomTitle');
    const roomMeta = el('roomMeta');
    const leaveRoomBtn = el('leaveRoomBtn');
    const gameContainer = el('gameContainer');
    
    // --- DURUM DEƒûƒ∞≈ûKENLERƒ∞ ---
    let currentUser = null;
    let currentRoomId = null;
    let currentRoomData = null;
    let unsubMessages = null;
    let unsubMembers = null;
    let unsubGame = null;

    // --- YARDIMCI FONKSƒ∞YONLAR ---
    const showToast = (msg, type='success') => {
      const w = el('toastWrapper');
      const t = document.createElement('div');
      t.className = `toast ${type}`;
      t.innerHTML = `<span class="material-icons-round">${type==='success'?'check_circle':'error'}</span> ${msg}`;
      w.appendChild(t);
      requestAnimationFrame(() => t.classList.add('show'));
      setTimeout(() => { t.classList.remove('show'); setTimeout(()=>t.remove(), 300); }, 3000);
    };

    const escapeHtml = (unsafe) => {
      return (unsafe || "").replace(/[&<"']/g, function(m) {
        switch (m) {
          case '&': return '&amp;';
          case '<': return '&lt;';
          case '>': return '&gt;';
          case '"': return '&quot;';
          default: return '&#039;';
        }
      });
    };

    // --- AUTH MANTIƒûI (Kullanƒ±cƒ± Adƒ± <-> Email D√∂n√º≈ü√ºm√º) ---
    // Firebase Auth sadece Email destekler, bu y√ºzden kullanƒ±cƒ± adƒ±nƒ± sahte bir emaile √ßeviriyoruz.
    const createFakeEmail = (username) => `${username.toLowerCase().replace(/[^a-z0-9]/g, '')}@lilemir.local`;

    const handleLogin = async () => {
      const username = el('loginUsername').value.trim();
      const password = el('loginPassword').value;
      
      if(username.length < 3) return authError.textContent = "Kullanƒ±cƒ± adƒ± en az 3 karakter olmalƒ±.";
      if(password.length < 6) return authError.textContent = "≈ûifre en az 6 karakter olmalƒ±.";

      authError.textContent = "ƒ∞≈üleniyor...";
      loginBtn.disabled = true;

      const fakeEmail = createFakeEmail(username);

      try {
        // √ñnce giri≈ü yapmayƒ± dene
        await auth.signInWithEmailAndPassword(fakeEmail, password);
        // Giri≈ü ba≈üarƒ±lƒ± ise state listener yakalar
      } catch (error) {
        if (error.code === 'auth/user-not-found') {
          // Kullanƒ±cƒ± yoksa, OTOMATƒ∞K KAYIT yap
          try {
            const userCred = await auth.createUserWithEmailAndPassword(fakeEmail, password);
            // Firestore'a profil kaydet
            await db.collection('users').doc(userCred.user.uid).set({
              uid: userCred.user.uid,
              username: username,
              displayName: username,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              balance: 0,
              admin: false
            });
            showToast('Hesap olu≈üturuldu ve giri≈ü yapƒ±ldƒ±.');
          } catch (createErr) {
            console.error(createErr);
            authError.textContent = "Kayƒ±t olu≈üturulamadƒ±: " + createErr.message;
            loginBtn.disabled = false;
          }
        } else if (error.code === 'auth/wrong-password') {
          authError.textContent = "Hatalƒ± ≈üifre.";
          loginBtn.disabled = false;
        } else {
          authError.textContent = error.message;
          loginBtn.disabled = false;
        }
      }
    };

    loginBtn.onclick = handleLogin;
    
    // Enter tu≈üu ile giri≈ü
    el('loginPassword').addEventListener('keyup', (e) => { if(e.key === 'Enter') handleLogin(); });

    // Admin Auth
    el('toggleAdminAuth').onclick = () => { authModal.classList.remove('active'); adminModal.classList.add('active'); };
    el('toggleUserAuth').onclick = () => { adminModal.classList.remove('active'); authModal.classList.add('active'); };
    
    el('adminLoginBtn').onclick = async () => {
      const email = el('adminEmail').value;
      const pass = el('adminPassword').value;
      try {
        await auth.signInWithEmailAndPassword(email, pass);
        adminModal.classList.remove('active');
      } catch(e) { el('adminError').textContent = e.message; }
    };

    el('logoutBtn').onclick = () => auth.signOut();

    // --- AUTH STATE LISTENER ---
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        authModal.classList.remove('active');
        adminModal.classList.remove('active');
        
        // Kullanƒ±cƒ± verisini √ßek
        let userData = {};
        try {
          const doc = await db.collection('users').doc(user.uid).get();
          if (doc.exists) userData = doc.data();
        } catch(e) { console.log(e); }

        currentUser = { ...user, ...userData };
        el('meName').textContent = currentUser.displayName || currentUser.username || "Kullanƒ±cƒ±";
        el('userBadge').textContent = currentUser.admin ? "Y√ñNETƒ∞Cƒ∞" : "√úye";
        
        loadRooms();
      } else {
        currentUser = null;
        authModal.classList.add('active');
        leaveRoom();
      }
    });

    // --- ODA Sƒ∞STEMƒ∞ ---
    const loadRooms = async () => {
      const list = el('roomsList');
      db.collection('rooms').orderBy('createdAt', 'desc').onSnapshot(snap => {
        list.innerHTML = '';
        snap.forEach(doc => {
          const r = doc.data();
          const div = document.createElement('div');
          div.className = 'room-item';
          div.innerHTML = `
            <div class="room-info">
              <h4>${escapeHtml(r.name)}</h4>
              <p>${escapeHtml(r.type)}</p>
            </div>
            <span class="material-icons-round" style="font-size:18px; color:var(--text-muted)">chevron_right</span>
          `;
          div.onclick = () => joinRoom(r.id);
          list.appendChild(div);
        });
      });
    };

    el('createRoomBtn').onclick = async () => {
      const name = el('newRoomName').value.trim();
      const type = el('newRoomType').value;
      if (!name) return showToast('Oda adƒ± girin', 'error');
      
      try {
        const roomRef = db.collection('rooms').doc();
        await roomRef.set({
          id: roomRef.id,
          name, type,
          owner: currentUser.uid,
          moderators: [currentUser.uid],
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          banned: []
        });
        el('newRoomName').value = '';
        showToast('Oda olu≈üturuldu');
      } catch(e) { showToast(e.message, 'error'); }
    };

    // --- ODA ƒ∞√áƒ∞ & CHAT ---
    const joinRoom = async (roomId) => {
      leaveRoom(); // √ñnceki odadan √ßƒ±k
      currentRoomId = roomId;
      
      // UI G√ºncelle
      gameContainer.style.display = "block";
      leaveRoomBtn.style.display = "block";
      
      // Mobilde sidebarƒ± kapat
      el('sidebar').classList.remove('open');

      // Oda Bilgisi
      db.collection('rooms').doc(roomId).onSnapshot(doc => {
        if (!doc.exists) return showToast('Oda silinmi≈ü', 'error');
        currentRoomData = doc.data();
        roomTitle.textContent = currentRoomData.name;
        roomMeta.textContent = currentRoomData.type;
        
        // Ban kontrol√º
        const banned = currentRoomData.banned || [];
        if (banned.includes(currentUser.uid)) {
           chatInput.disabled = true;
           chatInput.placeholder = "Bu odadan banlandƒ±nƒ±z.";
           sendBtn.disabled = true;
           el('tkgmChoices').style.display = 'none';
        } else {
           chatInput.disabled = false;
           chatInput.placeholder = "Mesaj yaz...";
           sendBtn.disabled = false;
           el('tkgmChoices').style.display = 'flex';
        }
        
        renderMembers();
      });

      // Mesajlarƒ± Dinle
      unsubMessages = db.collection('rooms').doc(roomId).collection('messages')
        .orderBy('timestamp', 'asc')
        .onSnapshot(snap => {
          chatMessages.innerHTML = '';
          snap.forEach(doc => {
            const m = doc.data();
            renderMessage(m);
          });
          chatMessages.scrollTop = chatMessages.scrollHeight;
        });

      // Oyun Ba≈ülat
      initGame();
    };

    const renderMessage = (m) => {
      const isMe = m.fromUid === currentUser.uid;
      const div = document.createElement('div');
      div.className = `msg ${isMe ? 'me' : ''}`;
      
      // Tarih formatƒ±
      const date = m.timestamp ? new Date(m.timestamp.toDate()) : new Date();
      const time = date.getHours().toString().padStart(2,'0') + ':' + date.getMinutes().toString().padStart(2,'0');

      div.innerHTML = `
        <div class="meta">
          <strong>${escapeHtml(m.displayName)}</strong>
          <span>${time}</span>
        </div>
        ${escapeHtml(m.text)}
      `;
      chatMessages.appendChild(div);
    };

    const leaveRoom = () => {
      if (unsubMessages) unsubMessages();
      if (unsubGame) unsubGame();
      currentRoomId = null;
      currentRoomData = null;
      roomTitle.textContent = "Oda Se√ßimi";
      roomMeta.textContent = "Sohbete ba≈ülamak i√ßin bir odaya katƒ±lƒ±n";
      chatMessages.innerHTML = `<div style="text-align:center; margin-top:50px; color:var(--text-muted);"><span class="material-icons-round" style="font-size:48px; opacity:0.5;">forum</span><p>Oda se√ßin</p></div>`;
      el('membersList').innerHTML = '';
      el('membersCount').textContent = '0';
      gameContainer.style.display = "none";
      leaveRoomBtn.style.display = "none";
      chatInput.disabled = true;
      sendBtn.disabled = true;
    };

    el('leaveRoomBtn').onclick = leaveRoom;

    // --- MESAJ G√ñNDERME ---
    const sendMessage = async () => {
      const text = chatInput.value.trim();
      if (!text || !currentRoomId) return;
      
      try {
        await db.collection('rooms').doc(currentRoomId).collection('messages').add({
          text,
          fromUid: currentUser.uid,
          displayName: currentUser.displayName || currentUser.username,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        chatInput.value = '';
      } catch(e) { console.error(e); }
    };
    
    sendBtn.onclick = sendMessage;
    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
    });

    // --- √úYELER VE MODERASYON ---
    const renderMembers = () => {
      const list = el('membersList');
      list.innerHTML = '';
      if (!currentRoomData) return;
      
      const mods = currentRoomData.moderators || [];
      const owner = currentRoomData.owner;
      
      // ≈ûimdilik sadece moderat√∂rleri listeliyoruz (demo ama√ßlƒ±)
      // Ger√ßek zamanlƒ± presence i√ßin Realtime Database gerekir, Firestore ile sadece yetkilileri g√∂sterebiliriz.
      // Ancak g√∂rsel olarak ≈üu anki kullanƒ±cƒ±yƒ± ve yetkilileri ekleyelim.
      
      const membersToShow = [...new Set([owner, ...mods, currentUser.uid])]; // Unique
      el('membersCount').textContent = membersToShow.length;

      membersToShow.forEach(uid => {
        const isOwner = uid === owner;
        const isMod = mods.includes(uid);
        const isMe = uid === currentUser.uid;
        
        let roleBadge = '';
        if(isOwner) roleBadge = '<span class="badge-role owner">Sahip</span>';
        else if(isMod) roleBadge = '<span class="badge-role mod">Mod</span>';

        const div = document.createElement('div');
        div.className = 'member-item';
        div.innerHTML = `
          <div>
            <span style="font-weight:${isMe?700:400}">${isMe ? 'Sen' : (uid.substring(0,6)+'...')}</span>
            ${roleBadge}
          </div>
        `;
        
        // Admin Actions
        if (!isMe && (currentUser.uid === owner || (mods.includes(currentUser.uid) && !isOwner))) {
           const actions = document.createElement('div');
           
           // Ban Button
           const banBtn = document.createElement('button');
           banBtn.className = 'btn ghost'; 
           banBtn.style.padding = '4px'; banBtn.style.minWidth='auto';
           banBtn.innerHTML = '<span class="material-icons-round" style="font-size:16px; color:#ef4444">block</span>';
           banBtn.onclick = () => banUser(uid);
           actions.appendChild(banBtn);

           div.appendChild(actions);
        }
        
        list.appendChild(div);
      });
    };

    const banUser = async (targetUid) => {
       if(!confirm('Bu kullanƒ±cƒ±yƒ± banlamak istiyor musun?')) return;
       const banned = currentRoomData.banned || [];
       await db.collection('rooms').doc(currentRoomId).update({
         banned: [...banned, targetUid]
       });
       showToast('Kullanƒ±cƒ± banlandƒ±');
    };

    // --- TA≈û KAƒûIT MAKAS (Geli≈ütirilmi≈ü) ---
    const initGame = () => {
      const status = el('tkgmStatus');
      const gameRef = db.collection('rooms').doc(currentRoomId).collection('rockpaperscissors');
      
      // Button Events
      const choices = el('tkgmChoices').querySelectorAll('button');
      choices.forEach(btn => {
        btn.onclick = () => sendGameMove(btn.dataset.choice);
      });

      unsubGame = gameRef.orderBy('createdAt', 'desc').limit(1).onSnapshot(snap => {
        if(snap.empty) {
          status.textContent = "Oyun hazƒ±r. Hamle yapƒ±n!";
          enableGameBtns(true);
          return;
        }
        
        const g = snap.docs[0].data();
        const docId = snap.docs[0].id;

        if (g.finished) {
          const res = g.result || {};
          let msg = "";
          if (res.outcome === 'draw') msg = "Berabere!";
          else if (res.winnerUid === currentUser.uid) msg = "KAZANDIN! üéâ";
          else msg = "Kaybettin üòî";
          
          status.innerHTML = `${msg} <br><span style="font-size:0.8em; color:var(--text-muted)">Yeni oyun ba≈ülƒ±yor...</span>`;
          enableGameBtns(false);
          // 3 saniye sonra yeni oyun i√ßin butonlarƒ± a√ß
          setTimeout(() => { 
             status.textContent = "Yeni Tur: Hamle yap!"; 
             enableGameBtns(true); 
          }, 3000);
        } else {
          // Oyun devam ediyor
          const p1 = g.player1;
          const p2 = g.player2;
          
          let myMove = null;
          if (p1 && p1.uid === currentUser.uid) myMove = p1.move;
          if (p2 && p2.uid === currentUser.uid) myMove = p2.move;

          if (myMove) {
            status.textContent = `Hamle yapƒ±ldƒ± (${moveEmoji(myMove)}). Rakip bekleniyor...`;
            enableGameBtns(false);
          } else {
            status.textContent = "Rakip hamle yaptƒ±! Sƒ±ra sende.";
            enableGameBtns(true);
          }
          
          // Eƒüer her iki taraf da oynadƒ±ysa ve client tarafƒ±ndaysak (finalize i√ßin backend/functions daha iyidir ama burada client trigger kullanƒ±yoruz)
          // Not: Orijinal koddaki transaction yapƒ±sƒ± karma≈üƒ±k olduƒüu i√ßin burada UI odaklƒ± basitle≈ütirdik, ancak orijinal koddaki "backend logic" bu UI ile √ßalƒ±≈ümaya devam edecektir.
        }
      });
    };

    const sendGameMove = async (move) => {
      // Orijinal koddaki i≈ülem mantƒ±ƒüƒ±na benzer, sadele≈ütirilmi≈ü hamle g√∂nderimi
      // Buradaki mantƒ±k: Son oyunu bul -> bitmi≈üse yeni yarat -> bitmemi≈üse katƒ±l
      const gameRef = db.collection('rooms').doc(currentRoomId).collection('rockpaperscissors');
      const snap = await gameRef.orderBy('createdAt', 'desc').limit(1).get();
      
      const playerObj = { 
        uid: currentUser.uid, 
        displayName: currentUser.displayName || currentUser.username, 
        move: move 
      };

      let shouldCreateNew = true;
      let docToUpdate = null;

      if (!snap.empty) {
        const doc = snap.docs[0];
        const data = doc.data();
        
        if (!data.finished) {
           // Mevcut oyuna katƒ±labilir miyiz?
           if (!data.player2 && data.player1.uid !== currentUser.uid) {
             shouldCreateNew = false;
             // Oyunu bitir
             const p1 = data.player1;
             const p2 = playerObj;
             const result = calculateWinner(p1, p2);
             
             await doc.ref.update({
               player2: p2,
               finished: true,
               result: result
             });
             // Sistem mesajƒ± g√∂nder
             sendSystemMessage(`Oyun Sonucu: ${p1.displayName} (${moveEmoji(p1.move)}) vs ${p2.displayName} (${moveEmoji(p2.move)}) -> ${result.outcome === 'draw' ? 'Berabere' : 'Kazanan: ' + (result.winnerUid === p1.uid ? p1.displayName : p2.displayName)}`);
           }
        }
      }

      if (shouldCreateNew) {
        await gameRef.add({
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          player1: playerObj,
          finished: false
        });
      }
    };

    const calculateWinner = (p1, p2) => {
      if (p1.move === p2.move) return { outcome: 'draw' };
      const rules = { rock: 'scissors', scissors: 'paper', paper: 'rock' };
      if (rules[p1.move] === p2.move) return { outcome: 'win', winnerUid: p1.uid, loserUid: p2.uid };
      return { outcome: 'win', winnerUid: p2.uid, loserUid: p1.uid };
    };

    const moveEmoji = (m) => {
      if(m==='rock') return 'ü™®';
      if(m==='paper') return 'üìÑ';
      if(m==='scissors') return '‚úÇÔ∏è';
      return '?';
    };

    const enableGameBtns = (state) => {
      const btns = el('tkgmChoices').querySelectorAll('button');
      btns.forEach(b => b.disabled = !state);
    };
    
    const sendSystemMessage = (text) => {
      db.collection('rooms').doc(currentRoomId).collection('messages').add({
        text, fromUid: 'system', displayName: 'Sistem',
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
    };

    // Mobile Menu
    el('mobileMenuBtn').onclick = () => {
      el('sidebar').classList.toggle('open');
    };
    // Dƒ±≈üarƒ± tƒ±klayƒ±nca sidebarƒ± kapat
    document.addEventListener('click', (e) => {
      const sidebar = el('sidebar');
      const btn = el('mobileMenuBtn');
      if (window.innerWidth <= 768 && sidebar.classList.contains('open') && !sidebar.contains(e.target) && !btn.contains(e.target)) {
        sidebar.classList.remove('open');
      }
    });

  </script>
</body>
</html>